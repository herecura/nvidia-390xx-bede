--- a/kernel/nvidia-drm/nvidia-drm-gem-nvkms-memory.c	2018-08-22 02:55:29.000000000 +0200
+++ b/kernel/nvidia-drm/nvidia-drm-gem-nvkms-memory.c	2018-12-17 21:36:16.896622704 +0100
@@ -237,6 +237,10 @@
 
     page_offset = vmf->pgoff - drm_vma_node_start(&gem->vma_node);
 
+#if defined(NV_VMF_INSERT_PFN_PRESENT)
+    (void)ret;
+    return vmf_insert_pfn(vma, address, pfn + page_offset);
+#else
     ret = vm_insert_pfn(vma, address, pfn + page_offset);
 
     switch (ret) {
@@ -255,6 +259,7 @@
     }
 
     return VM_FAULT_SIGBUS;
+#endif
 }
 
 /*
--- a/kernel/conftest.sh	2018-12-17 21:47:43.400567150 +0100
+++ b/kernel/conftest.sh	2018-12-17 21:47:54.958247032 +0100
@@ -3350,6 +3350,23 @@
 
             compile_check_conftest "$CODE" "NV_DRM_MODE_OBJECT_FIND_HAS_FILE_PRIV_ARG" | append_conftest "types"
         ;;
+
+        vmf_insert_pfn)
+            #
+            # Determine if the function vmf_insert_pfn() is
+            # present.
+            #
+            # Added by commit 1c8f422059ae5da07db7406ab916203f9417e396 ("mm:
+            # change return type to vm_fault_t") in v4.17 (2018-04-05)
+            #
+            CODE="
+            #include <linux/mm.h>
+            void conftest_vmf_insert_pfn(void) {
+                vmf_insert_pfn();
+            }"
+
+            compile_check_conftest "$CODE" "NV_VMF_INSERT_PFN_PRESENT" "" "functions"
+        ;;
     esac
 }
 
--- a/kernel/nvidia-drm/nvidia-drm.Kbuild	2018-12-17 21:38:22.000000000 +0100
+++ b/kernel/nvidia-drm/nvidia-drm.Kbuild	2018-12-17 21:49:26.395715304 +0100
@@ -65,6 +65,7 @@
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += drm_atomic_helper_disable_all
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += drm_atomic_helper_set_config
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += drm_atomic_helper_connector_dpms
+NV_CONFTEST_FUNCTION_COMPILE_TESTS += vmf_insert_pfn
 
 NV_CONFTEST_TYPE_COMPILE_TESTS += drm_bus_present
 NV_CONFTEST_TYPE_COMPILE_TESTS += drm_bus_has_bus_type
